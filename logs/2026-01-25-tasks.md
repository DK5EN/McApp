# Task Log: 2026-01-25

## MCProxy Bootstrap Architecture Implementation

### Summary

Complete rewrite of the MCProxy installation system from 3 separate scripts + manual intervention to a single unified, idempotent bootstrap script.

### Tasks Completed

- [x] Create directory structure (`bootstrap/`, `lib/`, `templates/`)
- [x] Implement main entry point (`mcproxy.sh`)
- [x] Implement state detection (`lib/detect.sh`)
- [x] Implement interactive configuration (`lib/config.sh`)
- [x] Implement system hardening (`lib/system.sh`)
- [x] Implement package management with uv (`lib/packages.sh`)
- [x] Implement app deployment (`lib/deploy.sh`)
- [x] Implement health checks (`lib/health.sh`)
- [x] Create config template (`templates/config.json.tmpl`)
- [x] Create systemd service template (`templates/mcproxy.service`)
- [x] Create Caddy config template (`templates/Caddyfile.tmpl`)
- [x] Create nftables firewall rules (`templates/nftables.conf`)
- [x] Create journald volatile config (`templates/journald.conf`)
- [x] Create Python requirements (`requirements.txt`)
- [x] Write documentation (`README.md`)
- [x] Add migration support for old installations
- [x] Handle sudo/VENV_DIR path correctly
- [x] Syntax validation of all shell scripts

### Files Created

| File | Lines | Purpose |
|------|-------|---------|
| `bootstrap/mcproxy.sh` | 343 | Main entry point |
| `bootstrap/lib/detect.sh` | 319 | State & version detection |
| `bootstrap/lib/config.sh` | 378 | Interactive prompts & validation |
| `bootstrap/lib/system.sh` | 359 | tmpfs, firewall, services |
| `bootstrap/lib/packages.sh` | 362 | apt + uv package management |
| `bootstrap/lib/deploy.sh` | 280 | Webapp + Python deployment |
| `bootstrap/lib/health.sh` | 249 | Health checks & diagnostics |
| `bootstrap/templates/*` | 179 | Configuration templates |
| `bootstrap/requirements.txt` | 17 | Python dependencies |
| `bootstrap/README.md` | 251 | User documentation |

**Total: ~2,737 lines**

### Key Design Decisions

1. **Single unified script** - One command for install/update/repair
2. **State detection** - fresh | incomplete | migrate | upgrade
3. **uv over pip** - 10-100x faster, lower memory footprint
4. **Idempotent operations** - Safe to re-run without breaking
5. **SD card protection** - tmpfs for /var/log, /tmp, journald
6. **Migration support** - Seamless upgrade from old scripts
7. **Debian multi-version** - Bookworm (3.11) and Trixie (3.14)

### Migration Support

Added detection and handling for existing installations:
- Detects old `~/venv` installation
- Creates new `~/mcproxy-venv` with uv
- Updates systemd service paths
- Preserves existing config.json
- Adds missing config fields automatically

### Testing Status

- [x] Shell syntax validation (bash -n)
- [ ] Fresh install on Bookworm
- [ ] Fresh install on Trixie
- [ ] Migration from old installation
- [ ] Upgrade scenario
- [ ] --fix repair mode
- [ ] --check dry-run mode

### Next Steps

1. Test on actual Raspberry Pi Zero 2W
2. Test migration from existing installation
3. Verify all services start correctly
4. Test health check endpoints
5. Document any edge cases found during testing

---

## OrbStack Testing + BLE Service Architecture Implementation

### Summary

Implemented a flexible BLE architecture that separates Bluetooth hardware access from the main MCProxy application, enabling development/testing on macOS using OrbStack while keeping real BLE hardware accessible on Raspberry Pi.

### Tasks Completed

- [x] Create `orb-testing.md` documentation
- [x] Create BLE service with FastAPI (`ble_service/`)
- [x] Create BLE client abstraction layer
- [x] Refactor MCProxy to use BLE client abstraction
- [x] Update `config.sample.json` with BLE settings
- [x] Update `config_loader.py` with BLE mode options
- [x] Update `requirements.txt` with new dependencies
- [x] Update `CLAUDE.md` with architecture documentation

### Files Created

| File | Lines | Purpose |
|------|-------|---------|
| `orb-testing.md` | ~220 | OrbStack development workflow documentation |
| `ble_service/src/__init__.py` | 10 | BLE service package init |
| `ble_service/src/ble_adapter.py` | ~560 | Clean D-Bus/BlueZ wrapper class |
| `ble_service/src/main.py` | ~320 | FastAPI REST API + SSE endpoints |
| `ble_service/pyproject.toml` | 35 | Service dependencies |
| `ble_service/mcproxy-ble.service` | 25 | Systemd service file |
| `ble_service/README.md` | ~120 | API documentation |
| `ble_client.py` | ~200 | Abstract BLE interface + factory |
| `ble_client_local.py` | ~130 | Local D-Bus implementation |
| `ble_client_remote.py` | ~380 | Remote HTTP/SSE client |
| `ble_client_disabled.py` | ~100 | No-op stub for testing |

**Total: ~2,100 lines**

### Files Modified

| File | Changes |
|------|---------|
| `config_loader.py` | Added BLE mode, remote_url, api_key, device_name/address fields |
| `config.sample.json` | Added BLE configuration section |
| `C2-mc-ws.py` | Uses BLE client abstraction, handles mode-based initialization |
| `requirements.txt` | Added aiohttp, aiohttp-sse-client, sse-starlette |
| `CLAUDE.md` | Full architecture documentation update |

### Architecture Overview

**Before:**
```
MCProxy (single process) → D-Bus → BlueZ → BLE device
```

**After (flexible):**
```
# Mode: local (default, unchanged behavior)
MCProxy → BLEClientLocal → ble_handler.py → D-Bus → BlueZ → BLE

# Mode: remote (distributed setup)
MCProxy → BLEClientRemote → HTTP/SSE → BLE Service → D-Bus → BlueZ → BLE
         (Mac/OrbStack)                  (Pi with BT)

# Mode: disabled (testing)
MCProxy → BLEClientDisabled (no-op)
```

### Configuration Options

```json
{
  "BLE_MODE": "local",           // "local" | "remote" | "disabled"
  "BLE_REMOTE_URL": "",          // URL for remote mode
  "BLE_API_KEY": "",             // API key for remote service
  "BLE_DEVICE_NAME": "",         // Auto-connect device name
  "BLE_DEVICE_ADDRESS": ""       // Auto-connect MAC address
}
```

Environment variable overrides:
- `MCPROXY_BLE_MODE` - Override mode
- `MCPROXY_BLE_URL` - Override remote URL
- `MCPROXY_BLE_API_KEY` - Override API key

### BLE Service API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/ble/status` | Connection status |
| GET | `/api/ble/devices` | Scan for devices |
| POST | `/api/ble/connect` | Connect to device |
| POST | `/api/ble/disconnect` | Disconnect |
| POST | `/api/ble/send` | Send message/command |
| POST | `/api/ble/pair` | Pair with device |
| POST | `/api/ble/unpair` | Remove pairing |
| POST | `/api/ble/settime` | Set device time |
| GET | `/api/ble/notifications` | SSE notification stream |
| GET | `/health` | Health check |

### Benefits

| Aspect | Before | After |
|--------|--------|-------|
| Testing | Must have BLE hardware | Remote BLE or mock |
| Code quality | Messy D-Bus in main app | Isolated, testable service |
| Deployment | Single monolith | Flexible: same Pi or split |
| Development | Flash SD card each test | Snapshot/restore in OrbStack |
| Debugging | Hard to isolate BLE issues | Service has own logs/tests |

### Testing Workflow

1. **OrbStack with disabled BLE**:
   ```bash
   export MCPROXY_BLE_MODE=disabled
   python C2-mc-ws.py
   ```

2. **OrbStack with remote BLE**:
   ```bash
   # On Pi:
   cd ble_service && uvicorn src.main:app --host 0.0.0.0 --port 8081

   # On Mac:
   export MCPROXY_BLE_MODE=remote
   export MCPROXY_BLE_URL=http://pi.local:8081
   python C2-mc-ws.py
   ```

3. **Pi with local BLE** (default):
   ```bash
   python C2-mc-ws.py  # Uses D-Bus/BlueZ directly
   ```

### Testing Status

- [x] Code implementation complete
- [ ] Test local mode on Pi
- [ ] Test remote mode (Mac → Pi)
- [ ] Test disabled mode in OrbStack
- [ ] Test SSE notification streaming
- [ ] Test auto-reconnect behavior
- [ ] Test BLE service as systemd unit
