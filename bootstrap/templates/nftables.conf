#!/usr/sbin/nft -f
# McApp firewall rules
# Generated by mcapp.sh bootstrap
#
# Required ports:
#   22/tcp   - SSH (rate limited, LAN exempt)
#   80/tcp   - HTTP (lighttpd webapp + API proxy)
#   1799/udp - MeshCom node communication
#   5353/udp - mDNS (avahi for .local resolution)
#
# Internal only (not exposed):
#   2981/tcp - FastAPI SSE/REST (proxied via lighttpd on :80)
#
# DO NOT disable:
#   - avahi-daemon (mDNS required for .local hostnames)
#   - bluetooth (BLE required for ESP32 communication)
#   - wpa_supplicant (WiFi connectivity)

flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    # Allow loopback interface
    iif lo accept

    # Allow established/related connections
    ct state established,related accept

    # Drop invalid packets
    ct state invalid drop

    # SSH - allow local LAN without rate limiting
    ip saddr { 192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12 } tcp dport 22 accept

    # SSH - rate limit external connections (6 new per minute)
    tcp dport 22 ct state new limit rate 6/minute accept

    # HTTP (lighttpd webapp + API proxy)
    tcp dport 80 accept

    # MeshCom UDP communication
    udp dport 1799 accept

    # mDNS for .local hostname resolution (avahi-daemon)
    # Required for discovering the Pi on local network
    # Restrict to multicast destinations per mDNS protocol spec
    ip daddr 224.0.0.251 udp dport 5353 accept
    ip6 daddr ff02::fb udp dport 5353 accept

    # ICMP (ping) - useful for diagnostics
    icmp type echo-request accept
    icmpv6 type echo-request accept

    # Log dropped packets (limited to prevent log spam)
    limit rate 5/minute log prefix "[nftables DROP] " flags all counter drop
  }

  chain forward {
    type filter hook forward priority 0; policy drop;
  }

  chain output {
    type filter hook output priority 0; policy accept;
  }
}
