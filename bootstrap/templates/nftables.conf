#!/usr/sbin/nft -f
# McApp firewall rules
# Generated by mcapp.sh bootstrap
#
# Required ports:
#   22/tcp   - SSH (rate limited, LAN exempt)
#   80/tcp   - HTTP (lighttpd webapp + API proxy)
#   1799/udp - MeshCom node communication
#   5353/udp - mDNS (avahi for .local resolution)
#
# Internal only (not exposed):
#   2981/tcp - FastAPI SSE/REST (proxied via lighttpd on :80)
#
# DO NOT disable:
#   - avahi-daemon (mDNS required for .local hostnames)
#   - bluetooth (BLE required for ESP32 communication)
#   - wpa_supplicant (WiFi connectivity)

flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    # Allow loopback interface
    iif lo accept

    # Allow established/related connections
    ct state established,related accept

    # Drop invalid packets
    ct state invalid drop

    # SSH - allow local LAN without rate limiting
    ip saddr { 192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12 } tcp dport 22 accept

    # SSH - rate limit external connections (6 new per minute)
    tcp dport 22 ct state new limit rate 6/minute accept

    # HTTP (lighttpd webapp + API proxy)
    tcp dport 80 accept

    # MeshCom UDP communication
    udp dport 1799 accept

    # mDNS for .local hostname resolution (avahi-daemon)
    # Required for discovering the Pi on local network
    # Restrict to multicast destinations per mDNS protocol spec
    ip daddr 224.0.0.251 udp dport 5353 accept
    ip6 daddr ff02::fb udp dport 5353 accept

    # ICMP (ping) - useful for diagnostics
    icmp type echo-request accept
    icmpv6 type echo-request accept

    # Silently drop common broadcast/multicast traffic to prevent log spam
    # These are normal network noise and don't need to be logged

    # Broadcast packets (layer 2 broadcast MAC)
    meta pkttype broadcast drop

    # Multicast packets (layer 2 multicast MAC)
    meta pkttype multicast drop

    # Global broadcast
    ip daddr 255.255.255.255 drop

    # Any traffic to 192.168.x.x broadcast addresses (covers /22, /23, /24 subnets)
    # This catches 192.168.71.255, 192.168.68.255, etc.
    ip daddr 192.168.0.0-192.168.255.255 udp drop
    ip daddr 192.168.0.0-192.168.255.255 meta l4proto igmp drop

    # SSDP/UPnP device discovery (UDP port 1900)
    udp dport 1900 drop

    # mDNS unicast queries (already allowed multicast mDNS above)
    udp sport 5353 drop
    udp dport 5353 drop

    # Common broadcast UDP ports (device discovery, gaming, etc)
    udp dport > 30000 drop

    # IGMP multicast group management (IP protocol 2)
    meta l4proto igmp drop

    # All ICMPv6 Neighbor Discovery and Multicast
    icmpv6 type { nd-router-advert, nd-router-solicit, nd-neighbor-solicit, nd-neighbor-advert, nd-redirect, mld-listener-query, mld-listener-report, mld-listener-done, mld2-listener-report } drop

    # Drop all link-local IPv6 traffic (fe80::/10) except what's explicitly allowed above
    ip6 saddr fe80::/10 drop
    ip6 daddr fe80::/10 drop

    # NetBIOS Name Service (Windows network browsing)
    udp dport { 137, 138 } drop

    # LLMNR (Link-Local Multicast Name Resolution - Windows)
    udp dport 5355 drop

    # Common multicast addresses
    ip daddr { 224.0.0.0/4, 239.0.0.0/8 } drop
    ip6 daddr ff00::/8 drop

    # Log remaining dropped packets (limited to prevent log spam)
    # Only unusual traffic should reach this rule now
    limit rate 5/minute log prefix "[nftables DROP] " flags all counter drop
  }

  chain forward {
    type filter hook forward priority 0; policy drop;
  }

  chain output {
    type filter hook output priority 0; policy accept;
  }
}
