#!/usr/sbin/nft -f
# MCProxy firewall rules
# Generated by mcproxy.sh bootstrap
#
# Required ports:
#   22/tcp   - SSH (rate limited)
#   443/tcp  - HTTPS (Caddy reverse proxy)
#   2981/tcp - WebSocket over TLS
#   1799/udp - MeshCom node communication
#   5353/udp - mDNS (avahi for .local resolution)
#
# DO NOT disable:
#   - avahi-daemon (mDNS required for .local hostnames)
#   - bluetooth (BLE required for ESP32 communication)
#   - wpa_supplicant (WiFi connectivity)

flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    # Allow loopback interface
    iif lo accept

    # Allow established/related connections
    ct state established,related accept

    # Drop invalid packets
    ct state invalid drop

    # SSH with rate limiting (3 new connections per minute)
    tcp dport 22 ct state new limit rate 3/minute accept

    # HTTPS (Caddy reverse proxy for webapp)
    tcp dport 443 accept

    # WebSocket over TLS (proxied by Caddy)
    tcp dport 2981 accept

    # MeshCom UDP communication
    udp dport 1799 accept

    # mDNS for .local hostname resolution (avahi-daemon)
    # Required for discovering the Pi on local network
    udp dport 5353 accept

    # ICMP (ping) - useful for diagnostics
    icmp type echo-request accept
    icmpv6 type echo-request accept

    # Log dropped packets (limited to prevent log spam)
    limit rate 5/minute log prefix "[nftables DROP] " flags all counter drop
  }

  chain forward {
    type filter hook forward priority 0; policy drop;
  }

  chain output {
    type filter hook output priority 0; policy accept;
  }
}
